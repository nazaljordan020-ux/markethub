<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw Funds - MarketHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 via-white to-orange-50 min-h-screen">
  <header class="sticky top-0 z-50 border-b border-orange-100 bg-white/80 backdrop-blur-md">
    <div class="container mx-auto flex h-16 items-center justify-between px-4">
      <a href="seller-dashboard.html" class="flex items-center gap-2">
        <svg class="h-7 w-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
        </svg>
        <span class="text-xl font-bold text-gray-900">MarketHub</span>
      </a>
      <div class="text-right">
        <div id="userName" class="text-sm font-medium text-gray-900"></div>
        <div id="walletBalance" class="text-xs text-gray-600"></div>
      </div>
    </div>
  </header>

  <div class="container mx-auto max-w-2xl px-4 py-8">
    <a href="seller-dashboard.html" class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-6">
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to Dashboard
    </a>

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Withdraw Funds</h1>
      <p class="mt-2 text-gray-600">Transfer your earnings to GCash</p>
    </div>

    <div id="successMessage" class="hidden rounded-lg border-2 border-green-200 bg-green-50 p-8 text-center">
      <svg class="mx-auto h-16 w-16 text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Withdrawal Requested!</h2>
      <p class="text-gray-600 mb-6">Your withdrawal request is pending approval. Funds will be sent to your GCash once confirmed.</p>
      <a href="seller-dashboard.html" class="inline-block bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg">Return to Dashboard</a>
    </div>

    <form id="withdrawForm" class="rounded-lg border border-orange-100 bg-white p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-2">Withdrawal Details</h2>
      <p class="text-sm text-gray-600 mb-6">Enter your GCash information</p>

      <div class="space-y-6">
        <div>
          <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount (₱)</label>
          <input type="number" id="amount" required min="100" step="0.01" placeholder="0.00"
            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500">
          <p class="text-sm text-gray-600 mt-1">Minimum: ₱100</p>
        </div>

        <div>
          <label for="gcashNumber" class="block text-sm font-medium text-gray-700 mb-2">GCash Number</label>
          <input type="tel" id="gcashNumber" required placeholder="09XX-XXX-XXXX"
            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500">
        </div>

        <div>
          <label for="gcashName" class="block text-sm font-medium text-gray-700 mb-2">GCash Account Name</label>
          <input type="text" id="gcashName" required placeholder="Juan Dela Cruz"
            class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500">
        </div>

        <div class="rounded-lg border border-orange-200 bg-orange-50 p-4">
          <h4 class="font-semibold text-gray-900">Important Notes:</h4>
          <ul class="mt-2 space-y-1 text-sm text-gray-700">
            <li>• Processing time: 1-3 business days</li>
            <li>• Ensure GCash details are correct</li>
            <li>• Admin will review and approve your request</li>
            <li>• Funds will be sent to your GCash once approved</li>
          </ul>
        </div>

        <button type="submit" id="submitBtn"
          class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Request Withdrawal
        </button>
      </div>
    </form>
  </div>

  <div id="toast" class="fixed bottom-4 right-4 hidden bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
    <div id="toastContent"></div>
  </div>

  <script>
    const firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
    if (!firebase.apps.length && firebaseConfig.apiKey) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    let userData = null;

    function showToast(title, description, variant = 'default') {
      const toast = document.getElementById('toast');
      const content = document.getElementById('toastContent');
      content.innerHTML = `
        <div class="font-semibold ${variant === 'destructive' ? 'text-red-900' : 'text-gray-900'}">${title}</div>
        <div class="text-sm ${variant === 'destructive' ? 'text-red-700' : 'text-gray-600'}">${description}</div>
      `;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const amount = parseFloat(document.getElementById('amount').value);
      const gcashNumber = document.getElementById('gcashNumber').value;
      const gcashName = document.getElementById('gcashName').value;

      if (amount > userData.walletBalance) {
        showToast('Insufficient Balance', 'You do not have enough funds', 'destructive');
        return;
      }

      if (amount < 100) {
        showToast('Invalid Amount', 'Minimum withdrawal is ₱100', 'destructive');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Processing...';

      try {
        await db.collection('withdrawals').add({
          userId: auth.currentUser.uid,
          userName: userData.name,
          amount: amount,
          gcashNumber: gcashNumber,
          gcashName: gcashName,
          status: 'pending',
          createdAt: new Date().toISOString()
        });

        const userRef = db.collection('users').doc(auth.currentUser.uid);
        await userRef.update({
          walletBalance: userData.walletBalance - amount
        });

        document.getElementById('withdrawForm').classList.add('hidden');
        document.getElementById('successMessage').classList.remove('hidden');
      } catch (error) {
        console.error('Error submitting withdrawal:', error);
        showToast('Error', 'Failed to submit withdrawal', 'destructive');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Request Withdrawal';
      }
    });

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        userData = userDoc.data();
        
        document.getElementById('userName').textContent = userData.name;
        document.getElementById('walletBalance').textContent = `Wallet: ₱${(userData.walletBalance || 0).toLocaleString()}`;
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
